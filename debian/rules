#!/usr/bin/make -f
include /usr/share/cdbs/1/rules/patchsys-quilt.mk
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/makefile.mk
include /usr/share/cdbs/1/rules/ocaml.mk

DEST_DIR = $(CURDIR)/debian/tmp

# files that need to be pre-processed to remove #if* directives before feeding
# them into ocamldoc
PP_FILES = \
	lib/bigstring.mli \
	lib/core_mutex.mli \
	lib/unix_ext.mli \
	$(NULL)

ifeq ($(OCAML_HAVE_OCAMLOPT),yes)
DEB_MAKE_BUILD_TARGET = all
DEB_MAKE_INSTALL_TARGET = install OCAMLFIND_INSTFLAGS="-destdir $(DEST_DIR) -ldconf ignore"
else
DEB_MAKE_BUILD_TARGET = byte
DEB_MAKE_INSTALL_TARGET = libinstall-byte-code OCAMLFIND_INSTFLAGS="-destdir $(DEST_DIR) -ldconf ignore"
endif

build/libcore-ocaml-dev::
	for file in $(PP_FILES) ; do \
		cp $$file $$file.debian ; \
		sed -i '/^#/d' $$file ; \
	done

clean::
	for file in $(PP_FILES) ; do \
		[ ! -f $$file.debian ] || mv $$file.debian $$file ; \
	done

build/libcore-ocaml-dev::
	mkdir -p $(DEST_DIR)
